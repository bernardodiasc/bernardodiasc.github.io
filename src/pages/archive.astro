---
import { getCollection, getEntry } from 'astro:content';
import Layout from '../layouts/Layout.astro';
import PageContent from '../components/PageContent.astro';
import PostsListing from '../components/PostsListing.astro';

const posts = await getCollection('posts');

const sortedPosts = posts.sort(
  (a, b) => b.data.date.getTime() - a.data.date.getTime()
);

type YearGroup = {
  year: number;
  posts: typeof items;
};

const items = await Promise.all(
  sortedPosts.map(async (post) => {
    const categoryEntry = post.data.category
      ? await getEntry('categories', post.data.category)
      : null;
    return {
      id: post.id,
      title: post.data.title,
      date: post.data.date,
      excerpt: post.data.excerpt,
      tags: post.data.tags,
      category: categoryEntry
        ? { id: categoryEntry.id, title: categoryEntry.data.title, icon: categoryEntry.data.icon }
        : undefined,
    };
  })
);

const grouped = items.reduce<Record<number, typeof items>>((acc, item) => {
  const year = item.date.getFullYear();
  if (!acc[year]) acc[year] = [];
  acc[year].push(item);
  return acc;
}, {});

const years = Object.keys(grouped)
  .map(Number)
  .sort((a, b) => b - a);
---

<Layout title="Archive of content">
  <PageContent>
    {years.map((year) => (
      <section>
        <h2>{year}</h2>
        <PostsListing items={grouped[year]} />
      </section>
    ))}
  </PageContent>
</Layout>
